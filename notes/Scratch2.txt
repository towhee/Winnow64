to do
- make sure selection is sorted by capture time
- FS cleared between runs
- manage abort in MW::generateFocusStack
- flags (incl useDepthMap in runFusion)
- are focusSlices CV_32F if recover from disk?

PMaxStream
    Merge: PMax
    Merge: Weighted

PMaxStreamWeighted (WeightedPower, WeightedSigma0)
Depth-biased erosion
Edge-adaptive sigma

Steps:
1.  Stream PMax Fusion. (Done)
2.  Add mergeMode Weighted (WeightedPower, WeightedSigma0). (Done)
3.  Add Depth-biased erosion.  (Is this done?)
4.  Add Edge-adaptive sigma.  (To do)

StreamPMax
StreamPMaxWeighted
StreamPMaxWeightedErosion
StreamPMaxWeightedErosionEdge


StmDMap
StmDMap_01  Splotchy background
    enableHardWeightsOnLowpass = true
    enableLowpassEqualization  = false
StmDMap_02  Same as StmDMap_01
    enableHardWeightsOnLowpass = true
    enableLowpassEqualization  = true
    StmDMap_02  Same as StmDMap_01
    enableHardWeightsOnLowpass = false
    enableLowpassEqualization  = true

•	FSFusion.h / FSFusion.cpp (facade + shared helpers + dispatch)
•	FSFusionPMax.h / FSFusionPMax.cpp (PMax only, including streaming PMax)
•	FSFusionDMap.h / FSFusionDMap.cpp (DMap only, including streaming DMap)
•	FusionPyr.h / FusionPyr.cpp (pyramid accumulator + accumulate/finalize + a few pyramid helpers used by DMap)
•	FusionUtils.h (small inline helpers: seEllipse, rectInside, clamp helpers, etc.)

1.	This expects FSFusionDMap to have these members (as in your old FSFusion state):
        •	bool active; int sliceCount;
        •	cv::Size padSize, alignSize, origSize;
        •	cv::Rect validAreaAlign;
        •	int outDepth;
        •	TopKMaps topKPad;
        •	DMapParams params;
        •	reset(), streamSlice(...), finish(...)


2.	It also expects your FSLoader::loadAlignedSliceOrig(...) signature to match what you used in the old code.

3.	FusionPyr.h must provide:
        •	struct PyrAccum { void reset(cv::Size,int); ... }
        •	void buildIndexPyrNearest(const cv::Mat&, int, std::vector<cv::Mat>&);
        •	void buildDepthEdgeVetoPyr(const std::vector<cv::Mat>&, int, const FSFusionDMap::DMapParams&, std::vector<cv::Mat>&);
        •	void accumulateSlicePyr(PyrAccum&, const cv::Mat&, const cv::Mat&, const std::vector<cv::Mat>&, const std::vector<cv::Mat>*, int sliceIdx, const FSFusionDMap::DMapParams&, int levels, float weightBlurSigma);
        •	cv::Mat finalizeBlend(const PyrAccum&, float eps);

4.	FusionUtils.h must provide:
        •	cv::Mat seEllipse(int px);
        •	bool rectInside(const cv::Rect&, const cv::Size&);
        •	float clampf(float,float,float);
        •	cv::Mat toFloat01(const cv::Mat& gray8);

halo_alphaBand.png
halo_band.png
halo_boundary.png
halo_cand.png
halo_donor_labels.png
halo_fg.png
halo_overlay.png


namespace FSFusionDMapShared
{
static inline uint16_t clampU16(int v) {
    if (v < 0) return 0;
    if (v > 65535) return 65535;
    return (uint16_t)v;
}

cv::Mat morphClose8(const cv::Mat& bin8, int px)
{
    CV_Assert(bin8.type() == CV_8U);
    if (bin8.empty() || px <= 0) return bin8.clone();
    cv::Mat out = bin8.clone();
    cv::morphologyEx(out, out, cv::MORPH_CLOSE, FSFusion::seEllipse(px));
    return out;
}







Tests:

2026-02-17 12:45:06 Fused faint, scattered halo; less than full FG
depthStableRadiusPx = 2
depthMaxRangeSlices = 1
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 1

2026-02-17 16:55:46 Fused Muddled BG, Fat FG
depthStableRadiusPx = 1
depthMaxRangeSlices = 1
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 1

2026-02-17 17:10:40 Fused no halo except FG overlap (twig in front of branch),
                    salt/pepper blobs in FG
depthStableRadiusPx = 3
depthMaxRangeSlices = 1
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 1
