to do
- robustMax99() sorts the entire image every time (expensive at 5k×4k).
  Not a correctness issue, but if you want it faster later, switch to histogram/binning or nth_element.



PMaxStream
    Merge: PMax
    Merge: Weighted

PMaxStreamWeighted (WeightedPower, WeightedSigma0)
Depth-biased erosion
Edge-adaptive sigma

Steps:
1.  Stream PMax Fusion. (Done)
2.  Add mergeMode Weighted (WeightedPower, WeightedSigma0). (Done)
3.  Add Depth-biased erosion.  (Is this done?)
4.  Add Edge-adaptive sigma.  (To do)

StreamPMax
StreamPMaxWeighted
StreamPMaxWeightedErosion
StreamPMaxWeightedErosionEdge


StmDMap
StmDMap_01  Splotchy background
    enableHardWeightsOnLowpass = true
    enableLowpassEqualization  = false
StmDMap_02  Same as StmDMap_01
    enableHardWeightsOnLowpass = true
    enableLowpassEqualization  = true
    StmDMap_02  Same as StmDMap_01
    enableHardWeightsOnLowpass = false
    enableLowpassEqualization  = true

•	FSFusion.h / FSFusion.cpp (facade + shared helpers + dispatch)
•	FSFusionPMax.h / FSFusionPMax.cpp (PMax only, including streaming PMax)
•	FSFusionDMap.h / FSFusionDMap.cpp (DMap only, including streaming DMap)
•	FusionPyr.h / FusionPyr.cpp (pyramid accumulator + accumulate/finalize + a few pyramid helpers used by DMap)
•	FusionUtils.h (small inline helpers: seEllipse, rectInside, clamp helpers, etc.)

1.	This expects FSFusionDMap to have these members (as in your old FSFusion state):
        •	bool active; int sliceCount;
        •	cv::Size padSize, alignSize, origSize;
        •	cv::Rect validAreaAlign;
        •	int outDepth;
        •	TopKMaps topKPad;
        •	DMapParams params;
        •	reset(), streamSlice(...), finish(...)


2.	It also expects your FSLoader::loadAlignedSliceOrig(...) signature to match what you used in the old code.

3.	FusionPyr.h must provide:
        •	struct PyrAccum { void reset(cv::Size,int); ... }
        •	void buildIndexPyrNearest(const cv::Mat&, int, std::vector<cv::Mat>&);
        •	void buildDepthEdgeVetoPyr(const std::vector<cv::Mat>&, int, const FSFusionDMap::DMapParams&, std::vector<cv::Mat>&);
        •	void accumulateSlicePyr(PyrAccum&, const cv::Mat&, const cv::Mat&, const std::vector<cv::Mat>&, const std::vector<cv::Mat>*, int sliceIdx, const FSFusionDMap::DMapParams&, int levels, float weightBlurSigma);
        •	cv::Mat finalizeBlend(const PyrAccum&, float eps);

4.	FusionUtils.h must provide:
        •	cv::Mat seEllipse(int px);
        •	bool rectInside(const cv::Rect&, const cv::Size&);
        •	float clampf(float,float,float);
        •	cv::Mat toFloat01(const cv::Mat& gray8);

halo_alphaBand.png
halo_band.png
halo_boundary.png
halo_cand.png
halo_donor_labels.png
halo_fg.png
halo_overlay.png


namespace FSFusionDMapShared
{
static inline uint16_t clampU16(int v) {
    if (v < 0) return 0;
    if (v > 65535) return 65535;
    return (uint16_t)v;
}

cv::Mat morphClose8(const cv::Mat& bin8, int px)
{
    CV_Assert(bin8.type() == CV_8U);
    if (bin8.empty() || px <= 0) return bin8.clone();
    cv::Mat out = bin8.clone();
    cv::morphologyEx(out, out, cv::MORPH_CLOSE, FSFusion::seEllipse(px));
    return out;
}







Tests:

2026-02-17 12:45:06 Fused faint, scattered halo; less than full FG
depthStableRadiusPx = 2
depthMaxRangeSlices = 1
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 5

2026-02-17 16:55:46 Fused Muddled BG, Fat FG
depthStableRadiusPx = 1
depthMaxRangeSlices = 1
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 5

RUN A
2026-02-17 17:10:40 Fused no halo, minor FG transition blur (twig in front of branch),
                    salt/pepper blobs in FG
depthStableRadiusPx = 3
depthMaxRangeSlices = 1
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 5

2026-02-18 06:22:31 Fused scattered halo, FG good, incl overlap
depthStableRadiusPx = 3
depthMaxRangeSlices = 2
strongFrac          = 0.01
weakFrac            = 0.03
seedDilatePx        = 2
closePx             = 5
openPx              = 1
scoreSigma          = 1.5
scoreKSize          = 3
ownershipClosePx    = 0
seedBandPx          = 1
pyrLevels           = 5

RUN B
2026-02-18 07:42:22 Same as RUN A with slightly better FG edges BUT minor halos.
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1        // > 1 adds slight focus halo
depthMaxRangeSlicesLoose = 2
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 2
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 0
seedBandPx               = 1
pyrLevels                = 5

2026-02-18 07:50:51 Improved FG transition but added slight focus halo
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 3        // > 2 adds slight focus halo
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 2
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 0
seedBandPx               = 1
pyrLevels                = 5

2026-02-18 08:10:57 Fixes FG transition but adds slight focus halo blur
depthStableRadiusPx      = 2 // < 3 Fixes FG transition but adds slight focus halo blur
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 2
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 2
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 0
seedBandPx               = 1
pyrLevels                = 5

2026-02-18 08:18:59
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 2
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 2
closePx                  = 5
openPx                   = 1
interiorPx               = 10   // no change to FG transition blur
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 0
seedBandPx               = 1
pyrLevels                = 5

RUN C
2026-02-18 08:27:04 Same as run B
depthStableRadiusPx      = 3    // < 3 focus halos
depthMaxRangeSlicesCore  = 1    // > 1 focus halos
depthMaxRangeSlicesLoose = 2    // > 2 focus halos
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 1    // 1..2 no visual impact
closePx                  = 5
openPx                   = 1
interiorPx               = 3    // increase no visual impact
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 0
seedBandPx               = 1
pyrLevels                = 5

RUN D
2026-02-18 08:43:26
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 1
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 1
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 0
seedBandPx               = 1
pyrLevels                = 5

026-02-18 12:02:36 No focus halos, improved FG edge
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 5    // improved FG edge (sweet spot?)
expandTexFrac            = 0.02
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 1
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 3
seedBandPx               = 1
pyrLevels                = 5

2026-02-18 12:04:36 Better than 12:02:36
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 1
expandTexFrac            = 0.02
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 1
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 3
seedBandPx               = 1
pyrLevels                = 5

2026-02-18 12:14:20
depthStableRadiusPx      = 3
depthMaxRangeSlicesCore  = 1
depthMaxRangeSlicesLoose = 5
expandTexFrac            = 0.05
strongFrac               = 0.03
weakFrac                 = 0.01
seedDilatePx             = 1
closePx                  = 5
openPx                   = 1
interiorPx               = 3
scoreSigma               = 1.5
scoreKSize               = 3
ownershipClosePx         = 3
seedBandPx               = 1
pyrLevels                = 5

2026-02-19 10:23:13
Method                       = DMap
FOCUS METRIC:
scoreSigma                   = 1.5
scoreKSize                   = 3
FOREGROUND:
depthStableRadiusPx          = 3
depthMaxRangeSlicesCore      = 1
depthMaxRangeSlicesLoose     = 5
expandTexFrac                = 0.05
strongFrac                   = 0.03
weakFrac                     = 0.01
seedDilatePx                 = 1
closePx                      = 5
openPx                       = 1
interiorPx                   = 3
OWNERSHIP PROPOGATION:
ownershipClosePx             = 3
seedBandPx                   = 1
Contrast Threshold:
enableContrastThreshold      = true
contrastMinFrac              = 0.01
lowContrastMedianK           = 5
lowContrastDilatePx          = 0
PYRAMID FUSION:
pyrLevels                    = 5
enableHardWeightsOnLowpass   = false
enableDepthGradLowpassVeto   = false
hardFromLevel                = 4
vetoFromLevel                = -1
vetoStrength                 = 1
weightBlurSigma              = 0
mixEps                       = 1e-06
wMin                         = 0

2026-02-21 07:06:07 Blotchy background
Method                        = DMap
FOCUS METRIC:
 scoreSigma                   = 0.75
 scoreKSize                   = 3
FOREGROUND:
 depthStableRadiusPx          = 3
 depthMaxRangeSlicesCore      = 1
 depthMaxRangeSlicesLoose     = 5
 expandTexFrac                = 0.05
 strongFrac                   = 0.03
 weakFrac                     = 0.01
 seedDilatePx                 = 1
 closePx                      = 5
 openPx                       = 1
 interiorPx                   = 3
OWNERSHIP PROPOGATION:
 ownershipClosePx             = 3
 seedBandPx                   = 1
CONTRAST THRESHOLD:
 enableContrastThreshold      = false
 contrastMinFrac              = 0.2
 lowContrastMedianK           = 5
 lowContrastDilatePx          = 1
PYRAMID FUSION:
 enablePyramidBlend           = true
 pyrLevels                    = 5
 enableHardWeightsOnLowpass   = true
 enableDepthGradLowpassVeto   = false
 hardFromLevel                = 0
 vetoFromLevel                = -1
 vetoStrength                 = 1
 weightBlurSigma              = 0
 mixEps                       = 1e-06
 wMin                         = 0

2026-02-21 10:27:25
Ligth leaf areas in upper are blowing out in final fused image,
depthIndex16 mostly slice 8
Fusion                        = DMap
FOCUS METRIC:
 focusMetricMethod            = Laplacian
 scoreSigma                   = 0.75
 scoreKSize                   = 3
FOREGROUND:
 depthStableRadiusPx          = 3
 depthMaxRangeSlicesCore      = 1
 depthMaxRangeSlicesLoose     = 5
 expandTexFrac                = 0.05
 strongFrac                   = 0.03
 weakFrac                     = 0.01
 seedDilatePx                 = 1
 closePx                      = 5
 openPx                       = 1
 interiorPx                   = 3
OWNERSHIP PROPOGATION:
 ownershipClosePx             = 3
 seedBandPx                   = 1
CONTRAST THRESHOLD:
 enableContrastThreshold      = true
 contrastMinFrac              = 0.2
 lowContrastMedianK           = 5
 lowContrastDilatePx          = 1
PYRAMID FUSION:
 enablePyramidBlend           = false
 pyrLevels                    = 5
 enableHardWeightsOnLowpass   = false
 enableDepthGradLowpassVeto   = false
 hardFromLevel                = 0
 vetoFromLevel                = -1
 vetoStrength                 = 1
 weightBlurSigma              = 0
 mixEps                       = 1e-06
 wMin                         = 0






CONCLUSIONS:

Method                         = DMap
FOCUS METRIC:
 focusMetricMethod             = Laplacian // Tennengrad false detail
 scoreSigma                    = 0.75     // Higher 1.0..1.5 = FG transition blur
 scoreKSize                    = 3        // 1..3 no visual impact
FOREGROUND:
 depthStableRadiusPx           = 3        // < 3 focus halos
 depthMaxRangeSlicesCore       = 1        // > 1 focus halos
 depthMaxRangeSlicesLoose      = 5        // 1 = better FG edges 10 = minor halos
 expandTexFrac                 = 0.05     // 0.01..0.05 no visual impact
 strongFrac                    = 0.03
 weakFrac                      = 0.01
 seedDilatePx                  = 1        // 1..2 no visual impact
 closePx                       = 5
 openPx                        = 1        // 0 = focus halo
 interiorPx                    = 3        // 3..10 no visual impact
OWNERSHIP PROPOGATION:
 ownershipClosePx              = 3        // 0..4 no visual impact
 seedBandPx                    = 1
CONTRAST THRESHOLD:
 enableContrastThreshold       = true
 contrastMinFrac               = 0.01
 lowContrastMedianK            = 5
 lowContrastDilatePx           = 0
PYRAMID FUSION:
 pyrLevels                     = 5
 enableHardWeightsOnLowpass    = false  // true = blotchy background
 enableDepthGradLowpassVeto    = false
 hardFromLevel                 = 4
 vetoFromLevel                 = -1
 vetoStrength                  = 1
 weightBlurSigma               = 0
 mixEps                        = 1e-06
 wMin                          = 0

